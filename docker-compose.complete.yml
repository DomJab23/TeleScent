services:
  # Backend API Server
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: telescent-backend
    ports:
      - "5001:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - JWT_SECRET=telescent-production-secret-change-this-in-production
      - DB_PATH=/app/backend/database.sqlite
    volumes:
      - ./backend/database.sqlite:/app/backend/database.sqlite
      - backend_logs:/app/backend/logs
    restart: unless-stopped
    networks:
      - telescent-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.telescent.service=backend"

  # Frontend React App (served by backend)
  # Note: Frontend is built and served by backend container
  # No separate container needed

  # ngrok Tunnel for Internet Access
  ngrok:
    image: ngrok/ngrok:latest
    container_name: telescent-ngrok
    command: http backend:5000 --log=stdout --log-level=info
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTH_TOKEN:-}
    ports:
      - "4040:4040"  # ngrok web interface
    volumes:
      - ./ngrok-config.yml:/etc/ngrok/ngrok.yml
    restart: unless-stopped
    networks:
      - telescent-network
    profiles:
      - ngrok
    labels:
      - "com.telescent.service=ngrok"

  # ML Service (Python-based)
  ml-service:
    build:
      context: ./ml
      dockerfile: Dockerfile.ml
    container_name: telescent-ml
    ports:
      - "5001:5001"
    environment:
      - FLASK_ENV=production
      - FLASK_PORT=5001
    volumes:
      - ./ml/models:/app/models
      - ./ml/data:/app/data
      - ml_logs:/app/logs
    restart: unless-stopped
    networks:
      - telescent-network
    profiles:
      - ml
    labels:
      - "com.telescent.service=ml"

  # Database Service (Optional - for future use)
  # Uncomment if you want to use PostgreSQL instead of SQLite
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: telescent-postgres
  #   environment:
  #     - POSTGRES_USER=telescent
  #     - POSTGRES_PASSWORD=telescent-secure-password
  #     - POSTGRES_DB=telescent
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   restart: unless-stopped
  #   networks:
  #     - telescent-network

  # Monitoring Service (Optional)
  # Uncomment if you want to monitor container health
  # watchtower:
  #   image: containrrr/watchtower
  #   container_name: telescent-watchtower
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   command: --interval 86400
  #   restart: unless-stopped
  #   networks:
  #     - telescent-network

networks:
  telescent-network:
    driver: bridge

volumes:
  backend_logs:
    driver: local
  ml_logs:
    driver: local
  # postgres_data:
  #   driver: local
